# A01 - sandbox 项目深度评审（当前仓库：wolo）

## 0) 一句话定位
Wolo 是一个面向开发者的 Python AI Agent CLI（带会话持久化、工具调用、MCP 扩展与路径安全），当前成熟度约在 **Beta 可用**，工程化基础扎实但在“工具契约鲁棒性”和“质量门禁强度”上仍有明显提升空间。

## 1) TL;DR 总结（5-10条）
1. **总体健康度**：架构分层清晰、模块边界明确、测试体量大（`tests/` 中 `def test_` 约 874 个），可维护性中上。
2. **主要优点**：工具注册中心统一（`wolo/tool_registry.py`）、PathGuard 机制独立模块化（`wolo/path_guard/*`）、CLI/执行/Agent 三层职责较清楚（`wolo/cli` + `wolo/agent.py`）。
3. **最大风险 Top 1**：工具名契约仍会被模型偏移触发（如 `bash`），执行器虽能报错但缺少“自动纠偏重试”层，导致可用性折损（`wolo/tools_pkg/executor.py:534`）。
4. **最大风险 Top 2**：PathGuard 依赖初始化时序，若绕过 CLI 入口直接调执行器，仍会触发中断级异常（`wolo/tools_pkg/path_guard_executor.py:84`）。
5. **最大风险 Top 3**：质量门禁偏松，覆盖率门槛仅 50%（`pyproject.toml:112`），CI 未覆盖类型检查（`.github/workflows/ci.yml`）。
6. **建议立刻做 Top 3（按 ROI）**：
   - P0：在工具执行前加“未知工具名别名纠偏层”（`bash -> shell`）+ 一次性重试，避免任务直接失败。
   - P1：给 PathGuard 增加 fail-safe 初始化兜底与错误指引，避免中间件未初始化时崩溃。
   - P1：提升质量门禁（覆盖率阈值、mypy 纳入 CI），用自动化把回归风险前移。
7. **最易被忽略但影响很大**：仓库中仍有“旧 MCP 占位实现”和“新 MCP 实现”并存（`wolo/mcp.py` vs `wolo/mcp_integration.py`），认知成本和维护风险偏高。

## 2) Repo 结构与核心流程速览
### 2.1 目录树解读（核心模块/边界）
```
wolo/
├── wolo/
│   ├── cli/                    # 入口、参数解析、命令路由、输出渲染
│   ├── agent.py                # 主循环：LLM流式事件 + 工具执行 + 会话更新
│   ├── tools_pkg/              # 工具实现与执行分发
│   ├── tool_registry.py        # 工具 schema/展示元数据单一来源
│   ├── path_guard/             # 路径保护检查、策略、持久化
│   ├── mcp/ + mcp_integration.py
│   ├── llm_adapter.py          # 基于 lexilux 的 LLM 适配
│   ├── session.py              # 会话与状态持久化
│   └── compaction/             # 历史压缩策略
├── tests/                      # unit/integration/path_safety/compaction
├── docs/                       # 设计、验证、评审文档
├── pyproject.toml              # 依赖、ruff/pytest/coverage
└── Makefile                    # 本地开发入口
```

### 2.2 关键执行路径（入口 -> 核心逻辑 -> 外部依赖）
1. 入口路由：`wolo/cli/main.py` 解析命令并分发到 run/repl/session/config。
2. 会话启动：`wolo/cli/commands/run.py` 组装 Config、Session、PathGuard、输出事件。
3. 主循环：`wolo/agent.py` 调 LLM（`wolo/llm_adapter.py`）并消费流式事件。
4. 工具执行：`wolo/tools_pkg/executor.py` 分发 `shell/read/write/edit/...`，写操作通过 `wolo/tools_pkg/path_guard_executor.py`。
5. 外部依赖：
   - LLM：OpenAI-compatible endpoint（lexilux client）。
   - MCP：本地/远程 MCP server（`wolo/mcp/server_manager.py`）。
   - 文件系统：session 持久化 + PathGuard 确认记录。

### 2.3 构建/运行/部署链路概览
1. 本地依赖：`uv sync --group dev --all-extras`（Makefile 中 dev-install/sync）。
2. 质量检查：`ruff check` + `ruff format --check` + `pytest -n auto`。
3. CI：`.github/workflows/ci.yml` 执行测试、lint、构建；`security.yml` 执行 `pip-audit` 和 `bandit`。
4. 发布：`release.yml` 按 tag 构建并发布。

## 3) 全维度评审（评分1-10 + 证据点 + 影响 + 建议）
| 维度 | 评分 | 证据点 | 影响 | 建议 |
|---|---:|---|---|---|
| 架构分层与边界 | 8 | CLI/执行/Agent/Tool 分层清晰；工具 schema 集中在 `wolo/tool_registry.py` | 新功能可插拔性较好 | 保持 registry 作为单一工具真源，不再新增平行定义 |
| 工具契约稳定性 | 6 | 明确声明 shell 工具名仅 `shell`（`wolo/tool_descriptions/shell.txt:3`），但执行器仍会收到 `bash` 并直接失败（`wolo/tools_pkg/executor.py:534`；测试 `tests/unit/test_wild_mode.py:59`） | 任务链路易被一次“错工具名”中断 | 增加 alias/canonicalize + 一次性重试机制（仅常见映射） |
| 路径安全机制 | 7 | 默认 `/tmp` 白名单（`wolo/path_guard/checker.py:40`）；run/repl/session 都初始化 PathGuard（`wolo/cli/commands/run.py:236` 等） | 主路径安全性已可用 | 对绕过 CLI 的调用路径补充 fail-safe 初始化或显式错误指引 |
| 错误可恢复性 | 6 | PathGuard 未初始化直接抛 RuntimeError（`wolo/tools_pkg/path_guard_executor.py:84`） | 对脚本化/嵌入式场景不友好，错误恢复成本高 | 将该异常升级为可操作提示并附加建议修复动作 |
| 安全防护（shell） | 8 | 高风险命令模式检测+交互确认+会话级放行（`wolo/tools_pkg/shell.py`，`tests/unit/test_shell_risk_guard.py`） | 明显降低误操作风险 | 风险模式建议加审计事件埋点用于后续分析 |
| 可测试性与回归防护 | 7 | 用例数量大（约 874 tests），关键行为有单测（wild/path/shell/cli） | 回归可发现性较好 | 覆盖率门槛提高，补关键流程集成测试 |
| 质量门禁强度 | 6 | 覆盖率下限仅 50（`pyproject.toml:112`）；CI 无 mypy 步骤（`.github/workflows/ci.yml`） | 隐性缺陷更容易漏到主干 | 提升 coverage fail_under 到 70+；将 mypy 纳入 CI |
| 依赖与交付一致性 | 7 | `pyproject.toml` 已声明 `lexilux>=2.5.0`；本地验证存在 `lexilux 2.5.0` | 环境可复现性基本可用 | 建议引导统一 `uv sync --group dev --all-extras`，减少“本地装法差异” |
| 文档与实现一致性 | 6 | 存在旧实现占位（`wolo/mcp.py` TODO）与新实现并存（`wolo/mcp_integration.py`） | 增加理解负担和误用风险 | 明确标注 deprecated 或移除未使用模块 |

## 4) 问题清单（按优先级排序）
| 优先级 | 问题 | 证据 | 风险 | 验收标准 |
|---|---|---|---|---|
| P0 | 工具名偏移导致执行硬失败（`bash`） | `wolo/tools_pkg/executor.py:534`，`tests/unit/test_wild_mode.py:59` | 单次误选工具即终止链路，任务成功率下降 | 引入 canonicalize 映射后，`bash` 触发自动改写为 `shell` 并继续执行；新增回归测试通过 |
| P1 | PathGuard 初始化时序耦合，非CLI路径易崩 | `wolo/tools_pkg/path_guard_executor.py:84` | 嵌入式调用稳定性不足 | 未初始化时返回可操作错误（含修复建议）；CLI路径行为不回归 |
| P1 | 质量门禁偏松 | `pyproject.toml:112`，`.github/workflows/ci.yml` | 缺陷进入主干概率较高 | 覆盖率门槛>=70；CI新增 mypy 步骤并稳定通过 |
| P2 | 旧 MCP 占位模块与新实现并存 | `wolo/mcp.py` 中多处 TODO | 长期维护成本上升 | 标注 deprecated 或下线；文档只保留一条 MCP 实现主线 |
| P2 | 文档术语残留与品牌迁移不彻底 | 多文档仍提到旧术语（如 GLM） | 影响认知统一和外部呈现 | 完成一次 docs 清洗，术语表统一 |

## 5) 后续开发建议与路线图（可执行）
### 5.1 ROI 排序后的 3-5 件事
1. **P0：工具名契约硬化（最高 ROI）**
2. **P1：PathGuard fail-safe 与错误恢复体验**
3. **P1：提高质量门禁（coverage + mypy）**
4. **P2：MCP 双轨实现收敛**
5. **P2：文档术语统一与健康度清理**

### 5.2 P0/P1 的“两套方案”
#### P0-1 工具名契约硬化（Unknown tool -> 自动纠偏）
- 短期可做（1-2 天）
  - 在 `execute_tool` 前加轻量 canonicalize：`{"bash":"shell"}`。
  - 对被改写的调用打 warning event，便于观测。
  - 增加单测：`bash` -> `shell` 可执行；未知值仍报错。
- 长期正确（1-2 周）
  - 在 LLM 事件层增加工具调用 schema validator，强制只接受 registry 名字。
  - 对不合法工具名执行“结构化纠错回合”（给模型返回机器可读错误，触发一次自修复）。

#### P1-1 PathGuard fail-safe
- 短期可做（1 天）
  - `get_path_guard_middleware()` 未初始化时抛带修复建议的业务异常（不是裸 RuntimeError）。
  - 在 run/repl/session 启动后记录初始化状态日志，便于诊断。
- 长期正确（1 周）
  - 把 PathGuard 改为显式依赖注入（executor 不再读取全局单例），支持库模式安全复用。
  - 增加并发与跨入口集成测试矩阵（run/repl/session/嵌入调用）。

#### P1-2 质量门禁提升
- 短期可做（1-2 天）
  - 覆盖率门槛从 50 调整到 70。
  - CI 新增 `mypy`（先对 `wolo/cli` + `wolo/tools_pkg` 子集启用，降低首轮成本）。
- 长期正确（1-2 周）
  - 扩展到全包 mypy，建立分层类型严格度（核心路径 stricter）。
  - 为关键执行链路新增 e2e smoke tests（含 wild/solo/path_guard 工况）。

### 5.3 执行排期建议（不扩大产品能力范围）
1. **第 1 周**：完成 P0-1 + P1-1（修“易失败链路”）。
2. **第 2 周**：完成 P1-2（提门禁，压回归）。
3. **第 3 周**：处理 P2（MCP 模块收敛 + 文档清理）。

### 5.4 阶段验收标准
1. 功能稳定性：`Unknown tool: bash` 场景不再导致任务中断，且日志可追踪。
2. 路径安全：未初始化场景输出可执行修复建议，不再裸崩。
3. 质量门禁：CI 包含 ruff + pytest + mypy，主干持续绿灯。
4. 维护性：MCP 入口主线唯一、文档术语一致。

## 附：本次评审采样证据（运行结果）
1. `uv run python -c "import lexilux; print(lexilux.__version__)"` -> `2.5.0`。
2. `uv run pytest tests/unit/test_cli_execution.py -q` -> `14 passed`。
3. `uv run ruff check wolo/ tests/` -> `All checks passed`。
